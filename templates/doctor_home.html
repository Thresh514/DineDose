<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Doctor Home</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='public/logo.ico') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', filename='doctor.css') }}">
</head>
<body>

    {% include "components/doctor_sidebar.html" %}

    <div class="main-container">
        <h1 class="page-title">My Patients</h1>

        <div id="patient-list">
            <div class="home-page-add-card" id="add-patient-card">
                <div class="home-page-add-card-placeholder" id="add-patient-placeholder">
                    <i class="fas fa-plus"></i>
                    <span>Add Patient</span>
                </div>
                <div class="home-page-add-card-form" id="add-patient-form" style="display: none;">
                    <input 
                        type="email" 
                        id="patient-email-input" 
                        class="home-page-add-input" 
                        placeholder="Patient email"
                    />
                    <div class="home-page-add-form-actions">
                        <button class="home-page-add-btn" id="add-patient-btn">Add</button>
                        <button class="home-page-cancel-btn" id="cancel-add-btn">Cancel</button>
                    </div>
                    <div id="add-patient-message" class="home-page-message"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        window.addEventListener("load", function () {
            const doctorId = "{{ doctor_id }}";

            fetch(`/get_patients?id=${doctorId}`)
                .then(res => res.json())
                .then(patients => {
                    const list = document.getElementById("patient-list");
                    // Keep add card, remove other content
                    const addCard = document.getElementById("add-patient-card");
                    list.innerHTML = "";
                    list.appendChild(addCard);

                    if (!patients.length) {
                        return;
                    }

                    patients.forEach(p => {
                        const name = p.username || "(No name)";
                        const email = p.email || "";
                        const avatarText = name.charAt(0).toUpperCase();

                        const card = document.createElement("div");
                        card.className = "home-page-card";
                        card.setAttribute("data-patient-id", p.id);

                        card.innerHTML = `
                            <div class="home-page-card-header">
                                <div class="home-page-avatar">${avatarText}</div>
                                <div class="home-page-card-info">
                                    <div class="home-page-name">${name}</div>
                                    <div class="home-page-email">${email}</div>
                                </div>
                            </div>
                            <div class="home-page-card-actions">
                                <a href="/doctor/plan_item_create?patient_id=${p.id}" class="home-page-action-btn home-page-btn-plan">
                                    <i class="fas fa-plus"></i> Add Plan Item
                                </a>
                                <a href="/doctor/feedback" class="home-page-action-btn home-page-btn-feedback">
                                    <i class="fas fa-comment"></i> Add Feedback
                                </a>
                                <button class="home-page-action-btn home-page-btn-remove" data-patient-id="${p.id}" data-patient-name="${name}">
                                    <i class="fas fa-trash"></i> Remove
                                </button>
                            </div>
                        `;

                        list.appendChild(card);
                    });

                    // Event delegation: click Remove button
                    list.addEventListener("click", function (e) {
                        if (!e.target.closest(".home-page-btn-remove")) return;

                        const btn = e.target.closest(".home-page-btn-remove");
                        const patientId = btn.dataset.patientId;
                        const patientName = btn.dataset.patientName;

                        if (confirm(`Are you sure you want to remove ${patientName} from your patient list? This action cannot be undone.`)) {
                            removePatient(patientId, btn);
                        }
                    });
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById("patient-list").textContent =
                        "Error loading patients.";
                });

            // Add patient functionality
            const addPatientCard = document.getElementById("add-patient-card");
            const addPatientPlaceholder = document.getElementById("add-patient-placeholder");
            const addPatientForm = document.getElementById("add-patient-form");
            const addPatientBtn = document.getElementById("add-patient-btn");
            const cancelAddBtn = document.getElementById("cancel-add-btn");
            const patientEmailInput = document.getElementById("patient-email-input");
            const messageDiv = document.getElementById("add-patient-message");

            // Click placeholder to show form
            addPatientPlaceholder.addEventListener("click", function() {
                addPatientPlaceholder.style.display = "none";
                addPatientForm.style.display = "block";
                patientEmailInput.focus();
            });

            // Click cancel button to hide form
            cancelAddBtn.addEventListener("click", function() {
                addPatientForm.style.display = "none";
                addPatientPlaceholder.style.display = "flex";
                patientEmailInput.value = "";
                messageDiv.style.display = "none";
            });

            function showMessage(text, isError) {
                messageDiv.textContent = text;
                messageDiv.className = "home-page-message " + (isError ? "error" : "success");
                messageDiv.style.display = "block";
                setTimeout(() => {
                    messageDiv.style.display = "none";
                }, 5000);
            }

            addPatientBtn.addEventListener("click", function() {
                const email = patientEmailInput.value.trim();
                if (!email) {
                    showMessage("Please enter patient email", true);
                    return;
                }

                addPatientBtn.disabled = true;
                addPatientBtn.textContent = "Adding...";

                fetch("/doctor/add_patient", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ email: email }),
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) {
                            showMessage(data.error, true);
                        } else {
                            showMessage(data.message || "Patient added successfully", false);
                            patientEmailInput.value = "";
                            // Reload patient list
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        showMessage("Failed to add patient. Please try again.", true);
                    })
                    .finally(() => {
                        addPatientBtn.disabled = false;
                        addPatientBtn.textContent = "Add";
                    });
            });

            // Support Enter key submission
            patientEmailInput.addEventListener("keypress", function(e) {
                if (e.key === "Enter") {
                    addPatientBtn.click();
                }
            });

            // Remove patient functionality
            function removePatient(patientId, button) {
                button.disabled = true;
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Removing...';

                fetch(`/doctor/remove_patient`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ patient_id: parseInt(patientId) }),
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) {
                            alert("Error: " + data.error);
                            button.disabled = false;
                            button.innerHTML = originalText;
                        } else {
                            // Remove card
                            const card = button.closest(".home-page-card");
                            if (card) {
                                card.style.transition = "opacity 0.3s";
                                card.style.opacity = "0";
                                setTimeout(() => {
                                    card.remove();
                                    // Show message if no patients left
                                    const list = document.getElementById("patient-list");
                                    if (list.children.length === 0) {
                                        list.textContent = "You currently have no patients.";
                                    }
                                }, 300);
                            }
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert("Failed to remove patient. Please try again.");
                        button.disabled = false;
                        button.innerHTML = originalText;
                    });
            }
        });
    </script>
</body>
</html>
{% set uid = session.get('user_id') %}
{% extends 'patient_base.html' %}
{% block content %}

<div class="notification-settings-page">
    <div class="notification-settings-header">
        <h1 class="notification-settings-title">Notification Settings</h1>
        <p class="notification-settings-description">
            Configure how and when Dine Dose should remind you about your tasks and plans.
        </p>
    </div>

    <div class="notification-settings-card" id="patient-notification-setting-{{ uid }}" data-user-id="{{ uid }}">

        <form class="notification-settings-form">
            <!-- Enable / Disable notifications -->
            <div class="notification-setting-item">
                <label class="notification-setting-label" for="notif-enabled-{{ uid }}">
                    Enable notifications
                </label>
                <label class="notification-switch">
                    <input
                        class="notification-switch-input"
                        type="checkbox"
                        id="notif-enabled-{{ uid }}"
                        name="enabled"
                    />
                    <span class="notification-switch-slider"></span>
                </label>
            </div>

            <!-- Email notifications -->
            <div class="notification-setting-item">
                <label class="notification-setting-label" for="notif-email-enabled-{{ uid }}">
                    Via Email
                </label>
                <label class="notification-switch">
                    <input
                        class="notification-switch-input"
                        type="checkbox"
                        id="notif-email-enabled-{{ uid }}"
                        name="email_enabled"
                    />
                    <span class="notification-switch-slider"></span>
                </label>
            </div>

            <!-- Notify minutes (chip list) -->
            <div class="notification-minutes-section">
                <label class="notification-section-label">Notification Times</label>
                
                <!-- chips container -->
                <div class="notification-chips-container" id="notif-minutes-chips-{{ uid }}">
                    <!-- chips rendered by JS -->
                </div>

                <!-- input + add button -->
                <div class="notification-input-group">
                    <input
                        type="number"
                        class="notification-input"
                        id="notif-minutes-input-{{ uid }}"
                        placeholder="Enter minutes, e.g. 60 or -60"
                        step="1"
                    />
                    <button
                        type="button"
                        class="notification-add-btn"
                        id="notif-minutes-add-{{ uid }}"
                    >
                        Add
                    </button>
                </div>

                <div class="notification-hint" id="notif-minutes-preview-{{ uid }}">
                    Example: 60 = 60 minutes before; 0 = at start time; -60 = 60 minutes after overdue.
                </div>
            </div>

            <div class="notification-actions">
                <button type="submit" class="notification-save-btn">
                    Save Settings
                </button>
                <span class="notification-status"></span>
            </div>
        </form>
    </div>
</div>

<script>
  (function () {
    const root = document.getElementById(
      "patient-notification-setting-{{ uid }}"
    );
    if (!root) return;

    const userId = parseInt(root.dataset.userId, 10);
    const form = root.querySelector(".notification-settings-form");
    const enabledInput = root.querySelector("#notif-enabled-{{ uid }}");
    const emailEnabledInput = root.querySelector(
      "#notif-email-enabled-{{ uid }}"
    );
    const chipsContainer = root.querySelector(
      "#notif-minutes-chips-{{ uid }}"
    );
    const minutesInput = root.querySelector(
      "#notif-minutes-input-{{ uid }}"
    );
    const addBtn = root.querySelector(
      "#notif-minutes-add-{{ uid }}"
    );
    const minutesPreview = root.querySelector(
      "#notif-minutes-preview-{{ uid }}"
    );
    const statusSpan = root.querySelector(".notification-status");

    // keep timezone from backend, but do not expose to user
    let currentTimezone = "UTC-5";

    // Current minutes list (e.g. [60, 0, -60])
    let minutesList = [];

    // Default config if no record exists (dummy data)
    const DEFAULT_CONFIG = {
      enabled: true,
      email_enabled: true,
      notify_minutes: [60, 0, -60],
      timezone: "UTC-5",
    };

    function describeOffset(n) {
      if (n > 0) return n + " minutes before task start";
      if (n === 0) return "at task start time";
      return Math.abs(n) + " minutes after overdue";
    }

    function renderMinutesPreview() {
      if (!minutesList.length) {
        minutesPreview.textContent =
          "Positive = before start; 0 = start; negative = after overdue.";
        return;
      }
      minutesPreview.textContent = minutesList
        .map(describeOffset)
        .join("; ");
    }

    function renderChips() {
      chipsContainer.innerHTML = "";
      if (!minutesList.length) {
        chipsContainer.innerHTML =
          '<span class="notification-empty-hint">No times added yet. Add one below.</span>';
        renderMinutesPreview();
        return;
      }

      minutesList.forEach((n, idx) => {
        const chip = document.createElement("span");
        chip.className = "notification-chip";
        chip.innerHTML = `
          <span class="notification-chip-main">${n}</span>
          <span class="notification-chip-sub">${describeOffset(n)}</span>
          <button type="button" class="notification-chip-remove" data-index="${idx}">&times;</button>
        `;
        chipsContainer.appendChild(chip);
      });

      renderMinutesPreview();
    }

    function addMinuteFromInput() {
      const raw = (minutesInput.value || "").trim();
      if (!raw) return;
      const n = parseInt(raw, 10);
      if (Number.isNaN(n)) {
        minutesInput.value = "";
        return;
      }
      // avoid duplicates
      if (!minutesList.includes(n)) {
        minutesList.push(n);
        // optional: sort from earlier to later notification
        minutesList.sort((a, b) => a - b);
        renderChips();
      }
      minutesInput.value = "";
    }

    // chip remove handler (event delegation)
    chipsContainer.addEventListener("click", (e) => {
      const target = e.target;
      if (target.classList.contains("notification-chip-remove")) {
        const idx = parseInt(target.getAttribute("data-index"), 10);
        if (!Number.isNaN(idx)) {
          minutesList.splice(idx, 1);
          renderChips();
        }
      }
    });

    // add button
    if (addBtn) {
      addBtn.addEventListener("click", addMinuteFromInput);
    }

    // allow Enter to add
    if (minutesInput) {
      minutesInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          addMinuteFromInput();
        }
      });
    }

    async function loadConfig() {
      try {
        const resp = await fetch(`/get_notification_setting?id=${userId}`);

        let cfg;
        if (resp.ok) {
          cfg = await resp.json();
        } else if (resp.status === 404) {
          // 404: use dummy/default data, no error shown
          cfg = DEFAULT_CONFIG;
        } else {
          // other errors: also fall back to default silently
          cfg = DEFAULT_CONFIG;
        }

        enabledInput.checked = cfg.enabled ?? DEFAULT_CONFIG.enabled;
        emailEnabledInput.checked =
          cfg.email_enabled ?? DEFAULT_CONFIG.email_enabled;

        const mins = Array.isArray(cfg.notify_minutes)
          ? cfg.notify_minutes
          : DEFAULT_CONFIG.notify_minutes;

        minutesList = mins.slice();
        currentTimezone = cfg.timezone || DEFAULT_CONFIG.timezone;

        renderChips();
      } catch (err) {
        console.error("Failed to load notification config:", err);
        // network error: still use default dummy config
        enabledInput.checked = DEFAULT_CONFIG.enabled;
        emailEnabledInput.checked = DEFAULT_CONFIG.email_enabled;
        minutesList = DEFAULT_CONFIG.notify_minutes.slice();
        currentTimezone = DEFAULT_CONFIG.timezone;
        renderChips();
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusSpan.textContent = "Savingâ€¦";
      statusSpan.classList.remove("text-success", "text-danger");

      const payload = {
        user_id: userId,
        enabled: enabledInput.checked,
        email_enabled: emailEnabledInput.checked,
        notify_minutes: minutesList,
        timezone: currentTimezone,
      };

      try {
        const resp = await fetch("/update_notification_setting", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!resp.ok) throw new Error("Save failed");

        statusSpan.textContent = "Saved";
        statusSpan.classList.add("text-success");
      } catch (err) {
        console.error("Failed to save notification config:", err);
        statusSpan.textContent = "Failed to save";
        statusSpan.classList.add("text-danger");
      }
    });

    loadConfig();
  })();
</script>

{% endblock %}
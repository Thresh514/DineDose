<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Plan Editor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="{{ url_for('static', filename='doctor.css') }}">
</head>
<body>

    {% include "components/doctor_sidebar.html" %}

    <div class="editor-page-container">
        <div class="editor-page-content">
            <h1 class="page-title">Plan Editor</h1>
            <p style="color: #666; margin-bottom: 20px;">Patient: {{ patient_name }} (ID: {{ patient_id }})</p>

            <!-- Add New -->
            <div class="editor-page-add-section">
                <a class="btn-add" href="/doctor/plan_item_create?patient_id={{ patient_id }}">
                    <i class="fas fa-plus"></i> Add New Plan Item
                </a>
            </div>

            <hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;">

            <!-- Existing Plan Items -->
            <div class="editor-page-items-list">
                {% for item in plan.plan_items %}
                <div class="editor-page-item-box">
                    <div class="editor-page-item-header">
                        <h3 class="editor-page-item-title">
                            {{ item.drug_name }} {{ item.dosage }} {{ item.unit }}
                        </h3>
                        <span class="editor-page-info-icon" onclick="showDrugInfo('{{ item.drug_id }}')" title="View drug information"><i class="fas fa-info-circle"></i></span>
                    </div>

                    {% if item.note %}
                    <p class="editor-page-item-note"><b>Note:</b> {{ item.note }}</p>
                    {% endif %}

                    <div class="editor-page-rule-section">
                        <h4>Rule</h4>
                        {% if item.plan_item_rule %}
                            <div class="editor-page-rule-info">
                                <b>Start:</b> {{ item.plan_item_rule.start_date }} <br>
                                {% if item.plan_item_rule.end_date %}
                                <b>End:</b> {{ item.plan_item_rule.end_date }} <br>
                                {% endif %}
                                <b>Repeat:</b> {{ item.plan_item_rule.repeat_type }}

                                {% if item.plan_item_rule.repeat_type == "PRN" and item.plan_item_rule.interval_value %}
                                    ({{ item.plan_item_rule.interval_value }} h)
                                {% endif %}
                                <br>

                                {% if item.plan_item_rule.repeat_type == "WEEKLY" %}
                                    <b>Days:</b>
                                    {{ item.plan_item_rule.mon and 'Mon ' or '' }}
                                    {{ item.plan_item_rule.tue and 'Tue ' or '' }}
                                    {{ item.plan_item_rule.wed and 'Wed ' or '' }}
                                    {{ item.plan_item_rule.thu and 'Thu ' or '' }}
                                    {{ item.plan_item_rule.fri and 'Fri ' or '' }}
                                    {{ item.plan_item_rule.sat and 'Sat ' or '' }}
                                    {{ item.plan_item_rule.sun and 'Sun ' or '' }}
                                    <br>
                                {% endif %}

                                {% if item.plan_item_rule.repeat_type != "PRN" and item.plan_item_rule.times %}
                                    <b>Times:</b>
                                    {% for t in item.plan_item_rule.times %}
                                        {{ t }}{% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </div>
                        {% else %}
                            <p style="color: #999;">No rule</p>
                        {% endif %}
                    </div>

                    <div class="editor-page-item-actions">
                        <a href="/doctor/plan_item_edit?item_id={{ item.id }}&patient_id={{ patient_id }}" class="btn btn-edit">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        <a href="#" onclick="deleteItem({{ item.id }}); return false;" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Delete
                        </a>
                    </div>
                </div>
                {% endfor %}

                {% if not plan.plan_items %}
                <div class="editor-page-item-box" style="text-align: center; color: #999; padding: 40px;">
                    No plan items yet. Click "Add New Plan Item" to create one.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Modal for Drug Info -->
    <div class="editor-page-modal" id="drug-modal">
        <div class="editor-page-modal-content">
            <button class="editor-page-close-btn" onclick="closeModal()">✖</button>
            <h3>Drug Information</h3>
            <pre class="editor-page-drug-info" id="drug-info"></pre>
        </div>
    </div>

    <script>
        function deleteItem(item_id) {
            if (!confirm("Delete this plan_item?")) return;

            fetch(`/plan_item/${item_id}`, { method: "DELETE" })
                .then(r => r.json())
                .then(() => location.reload())
                .catch(err => {
                    console.error(err);
                    alert("Failed to delete item");
                });
        }

        async function showDrugInfo(drugId) {
            try {
                const resp = await fetch(`/get_drug?id=${drugId}`);
                const data = await resp.json();

                if (!resp.ok) {
                    alert("Failed to load drug info");
                    return;
                }

                // 渲染信息
                let text = "";
                for (let key in data) {
                    text += `${key}: ${data[key]}\n`;
                }

                document.getElementById("drug-info").textContent = text;
                document.getElementById("drug-modal").style.display = "flex";
            } catch (err) {
                console.error(err);
                alert("Network error while loading drug info");
            }
        }

        function closeModal() {
            document.getElementById("drug-modal").style.display = "none";
        }

        // 点击modal外部关闭
        document.getElementById("drug-modal").addEventListener("click", function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>

</body>
</html>

{% extends 'patient_base.html' %}
{% block content %}
<div class="plan-page h-screen" 
     data-plan-url="{{ url_for('patient_home.patient_plan_page') }}"
     data-user-id="{{ user_id }}"
     {% if selected_date %}data-selected-date="{{ selected_date.isoformat() }}"{% endif %}>
    <!-- Week controls -->
    <div class="plan-week-controls">
        <button class="week-nav-btn" id="prev-week-btn" aria-label="Previous week">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M15 18l-6-6 6-6"/>
            </svg>
        </button>
        <div class="week-range">
            {% if week_start and week_end %}
            <span class="week-range-text">
                {{ week_start.strftime('%b %d') }} - {{ week_end.strftime('%b %d, %Y') }}
            </span>
            {% endif %}
        </div>
        <button class="week-nav-btn" id="next-week-btn" aria-label="Next week">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 18l6-6-6-6"/>
            </svg>
        </button>
    </div>
    
    <!-- Week day nav -->
    <div class="plan-week-nav">
        {% if week_dates %}
            {% for day_info in week_dates %}
            <button class="week-day {% if day_info.is_selected %}active{% endif %} {% if day_info.is_today %}today{% endif %}" 
                    data-date="{{ day_info.date.isoformat() }}"
                    aria-label="{{ day_info.date.strftime('%A, %B %d') }}">
                <span class="week-day-letter">{{ day_info.day_letter }}</span>
                <span class="week-day-number">{{ day_info.date.day }}</span>
            </button>
            {% endfor %}
        {% else %}
            <button class="week-day active" data-day="0">S</button>
            <button class="week-day" data-day="1">M</button>
            <button class="week-day" data-day="2">T</button>
            <button class="week-day" data-day="3">W</button>
            <button class="week-day" data-day="4">T</button>
            <button class="week-day" data-day="5">F</button>
            <button class="week-day" data-day="6">S</button>
        {% endif %}
    </div>
    
    <!-- Sections -->
    <div class="plan-sections">
        {% if not morning_items and not noon_items and not evening_items %}
        <!-- Empty state -->
        <div class="plan-empty-state">
            <p class="plan-empty-text">No active plan today!</p>
        </div>
        {% else %}
        <!-- ===== Morning ===== -->
        <section class="time-section time-section--morning">
            <div class="time-section-bg">
                <img src="{{ url_for('static', filename='public/Sunrise.png') }}" alt="Morning" class="time-icon" aria-hidden="true">
            </div>
            <ul class="plan-item-list">
                {% if morning_items %}
                    {% for item in morning_items %}
                        {% set key = item.id|string + '_' + (item.date.isoformat() if item.date else '') + '_' + (item.time.isoformat() if item.time else '') %}
                        {% set rec = completed_map.get(key) %}
                        {% set rec_status = rec.status if rec else (rec['status'] if rec is not none and 'status' in rec else None) %}
                        {% set rec_time = rec.taken_time if rec else (rec['taken_time'] if rec is not none and 'taken_time' in rec else None) %}
                        {% set is_past_date = item.date and yesterday_date and item.date < yesterday_date %}
                    <li class="plan-item{% if rec_status %} plan-item--completed{% endif %}"
                        data-plan-item-id="{{ item.id }}"
                        data-drug-id="{{ item.drug_id }}"
                        data-expected-date="{{ item.date.isoformat() if item.date else '' }}"
                        data-expected-time="{{ item.time.isoformat() if item.time else '' }}"
                        data-completed="{% if rec_status %}1{% else %}0{% endif %}"
                        data-completion-status="{{ rec_status or '' }}"
                        data-completion-time="{{ rec_time or '' }}"
                        data-is-past-date="{% if is_past_date %}1{% else %}0{% endif %}">
                        <div class="plan-item-avatar">{{ (item.drug_name or 'A')[:1]|upper }}</div>
                        <div class="plan-item-content">
                            <span class="plan-item-name">{{ item.drug_name or 'List item' }}</span>
                            {% if item.dosage and item.unit %}
                            <span class="plan-item-dosage">{{ item.dosage }} {{ item.unit }}</span>
                            {% endif %}
                            {% if item.time %}
                                {% if item.time is string %}
                                    <span class="plan-item-time">{{ item.time }}</span>
                                {% else %}
                                    <span class="plan-item-time">{{ item.time.strftime('%I:%M %p') }}</span>
                                {% endif %}
                            {% endif %}
                            <span class="plan-item-status">
                                {% if rec_status == 'ON_TIME' %}
                                    Completed on time
                                {% elif rec_status == 'LATE' %}
                                    Completed late
                                {% elif rec_status == 'EARLY' %}
                                    Completed early
                                {% endif %}
                            </span>
                        </div>
                        <button class="plan-item-checkbox{% if rec_status %} checked{% endif %}{% if is_past_date %} disabled{% endif %}"
                                aria-label="{% if rec_status %}Already completed{% elif is_past_date %}Cannot modify past dates{% else %}Mark as completed{% endif %}"
                                {% if is_past_date %}disabled{% endif %}>
                            {% if rec_status %}
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            {% else %}
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            </svg>
                            {% endif %}
                        </button>
                    </li>
                    {% endfor %}
                {% endif %}
            </ul>
        </section>
        
        <!-- ===== Noon ===== -->
        <section class="time-section time-section--noon">
            <div class="time-section-bg">
                <img src="{{ url_for('static', filename='public/Sun.png') }}" alt="Noon" class="time-icon" aria-hidden="true">
            </div>
            <ul class="plan-item-list">
                {% if noon_items %}
                    {% for item in noon_items %}
                        {% set key = item.id|string + '_' + (item.date.isoformat() if item.date else '') + '_' + (item.time.isoformat() if item.time else '') %}
                        {% set rec = completed_map.get(key) %}
                        {% set rec_status = rec.status if rec else (rec['status'] if rec is not none and 'status' in rec else None) %}
                        {% set rec_time = rec.taken_time if rec else (rec['taken_time'] if rec is not none and 'taken_time' in rec else None) %}
                        {% set is_past_date = item.date and yesterday_date and item.date < yesterday_date %}
                    <li class="plan-item{% if rec_status %} plan-item--completed{% endif %}"
                        data-plan-item-id="{{ item.id }}"
                        data-drug-id="{{ item.drug_id }}"
                        data-expected-date="{{ item.date.isoformat() if item.date else '' }}"
                        data-expected-time="{{ item.time.isoformat() if item.time else '' }}"
                        data-completed="{% if rec_status %}1{% else %}0{% endif %}"
                        data-completion-status="{{ rec_status or '' }}"
                        data-completion-time="{{ rec_time or '' }}"
                        data-is-past-date="{% if is_past_date %}1{% else %}0{% endif %}">
                        <div class="plan-item-avatar">{{ (item.drug_name or 'A')[:1]|upper }}</div>
                        <div class="plan-item-content">
                            <span class="plan-item-name">{{ item.drug_name or 'List item' }}</span>
                            {% if item.dosage and item.unit %}
                            <span class="plan-item-dosage">{{ item.dosage }} {{ item.unit }}</span>
                            {% endif %}
                            {% if item.time %}
                                {% if item.time is string %}
                                    <span class="plan-item-time">{{ item.time }}</span>
                                {% else %}
                                    <span class="plan-item-time">{{ item.time.strftime('%I:%M %p') }}</span>
                                {% endif %}
                            {% endif %}
                            <span class="plan-item-status">
                                {% if rec_status == 'ON_TIME' %}
                                    Completed on time
                                {% elif rec_status == 'LATE' %}
                                    Completed late
                                {% elif rec_status == 'EARLY' %}
                                    Completed early
                                {% endif %}
                            </span>
                        </div>
                        <button class="plan-item-checkbox{% if rec_status %} checked{% endif %}{% if is_past_date %} disabled{% endif %}"
                                aria-label="{% if rec_status %}Already completed{% elif is_past_date %}Cannot modify past dates{% else %}Mark as completed{% endif %}"
                                {% if is_past_date %}disabled{% endif %}>
                            {% if rec_status %}
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            {% else %}
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            </svg>
                            {% endif %}
                        </button>
                    </li>
                    {% endfor %}
                {% endif %}
            </ul>
        </section>
        
        <!-- ===== Evening ===== -->
        <section class="time-section time-section--evening">
            <div class="time-section-bg">
                <img src="{{ url_for('static', filename='public/Sunset.png') }}" alt="Evening" class="time-icon" aria-hidden="true">
            </div>
            <ul class="plan-item-list">
                {% if evening_items %}
                    {% for item in evening_items %}
                        {% set key = item.id|string + '_' + (item.date.isoformat() if item.date else '') + '_' + (item.time.isoformat() if item.time else '') %}
                        {% set rec = completed_map.get(key) %}
                        {% set rec_status = rec.status if rec else (rec['status'] if rec is not none and 'status' in rec else None) %}
                        {% set rec_time = rec.taken_time if rec else (rec['taken_time'] if rec is not none and 'taken_time' in rec else None) %}
                        {% set is_past_date = item.date and yesterday_date and item.date < yesterday_date %}
                    <li class="plan-item{% if rec_status %} plan-item--completed{% endif %}"
                        data-plan-item-id="{{ item.id }}"
                        data-drug-id="{{ item.drug_id }}"
                        data-expected-date="{{ item.date.isoformat() if item.date else '' }}"
                        data-expected-time="{{ item.time.isoformat() if item.time else '' }}"
                        data-completed="{% if rec_status %}1{% else %}0{% endif %}"
                        data-completion-status="{{ rec_status or '' }}"
                        data-completion-time="{{ rec_time or '' }}"
                        data-is-past-date="{% if is_past_date %}1{% else %}0{% endif %}">
                        <div class="plan-item-avatar">{{ (item.drug_name or 'A')[:1]|upper }}</div>
                        <div class="plan-item-content">
                            <span class="plan-item-name">{{ item.drug_name or 'List item' }}</span>
                            {% if item.dosage and item.unit %}
                            <span class="plan-item-dosage">{{ item.dosage }} {{ item.unit }}</span>
                            {% endif %}
                            {% if item.time %}
                                {% if item.time is string %}
                                    <span class="plan-item-time">{{ item.time }}</span>
                                {% else %}
                                    <span class="plan-item-time">{{ item.time.strftime('%I:%M %p') }}</span>
                                {% endif %}
                            {% endif %}
                            <span class="plan-item-status">
                                {% if rec_status == 'ON_TIME' %}
                                    Completed on time
                                {% elif rec_status == 'LATE' %}
                                    Completed late
                                {% elif rec_status == 'EARLY' %}
                                    Completed early
                                {% endif %}
                            </span>
                        </div>
                        <button class="plan-item-checkbox{% if rec_status %} checked{% endif %}{% if is_past_date %} disabled{% endif %}"
                                aria-label="{% if rec_status %}Already completed{% elif is_past_date %}Cannot modify past dates{% else %}Mark as completed{% endif %}"
                                {% if is_past_date %}disabled{% endif %}>
                            {% if rec_status %}
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            {% else %}
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            </svg>
                            {% endif %}
                        </button>
                    </li>
                    {% endfor %}
                {% endif %}
            </ul>
        </section>
        {% endif %}
    </div>
</div>

<!-- Dialog Component -->
<div id="plan-dialog" class="plan-dialog" role="dialog" aria-labelledby="dialog-title" aria-modal="true">
    <div class="plan-dialog-overlay"></div>
    <div class="plan-dialog-content">
        <div class="plan-dialog-header">
            <h3 id="dialog-title" class="plan-dialog-title">Alert</h3>
            <button class="plan-dialog-close" aria-label="Close dialog">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                </svg>
            </button>
        </div>
        <div class="plan-dialog-body">
            <p id="dialog-message"></p>
        </div>
        <div class="plan-dialog-footer">
            <button class="plan-dialog-btn plan-dialog-btn--primary" id="dialog-confirm">Confirm</button>
        </div>
    </div>
</div>

<script>
(function() {
    var planPage = document.querySelector('.plan-page');
    var prevWeekBtn = document.getElementById('prev-week-btn');
    var nextWeekBtn = document.getElementById('next-week-btn');
    var weekDayButtons = document.querySelectorAll('.week-day[data-date]');
    
    if (!planPage) return;

    // ---------- Dialog ----------
    var dialog = document.getElementById('plan-dialog');
    var dialogMessage = document.getElementById('dialog-message');
    var dialogConfirm = document.getElementById('dialog-confirm');
    var dialogClose = document.querySelector('.plan-dialog-close');
    var dialogOverlay = document.querySelector('.plan-dialog-overlay');

    function showDialog(message, title) {
        if (!dialog || !dialogMessage) return;
        
        dialogMessage.textContent = message || '';
        if (title && document.getElementById('dialog-title')) {
            document.getElementById('dialog-title').textContent = title;
        }
        dialog.classList.add('show');
        
        if (dialogConfirm) {
            setTimeout(function() {
                dialogConfirm.focus();
            }, 100);
        }
    }

    function hideDialog() {
        if (dialog) {
            dialog.classList.remove('show');
        }
    }

    if (dialogConfirm) {
        dialogConfirm.addEventListener('click', hideDialog);
    }
    if (dialogClose) {
        dialogClose.addEventListener('click', hideDialog);
    }
    if (dialogOverlay) {
        dialogOverlay.addEventListener('click', hideDialog);
    }
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && dialog && dialog.classList.contains('show')) {
            hideDialog();
        }
    });
    
    var planPageUrl = planPage.getAttribute('data-plan-url') || '';
    var currentDateStr = planPage.getAttribute('data-selected-date');
    var currentUserId = planPage.getAttribute('data-user-id');

    // ---------- Week navigation ----------
    function navigateWeek(direction) {
        if (!currentDateStr) return;
        
        var currentDate = new Date(currentDateStr + 'T00:00:00');
        var daysToAdd = direction === 'next' ? 7 : -7;
        var newDate = new Date(currentDate);
        newDate.setDate(currentDate.getDate() + daysToAdd);
        
        var year = newDate.getFullYear();
        var month = String(newDate.getMonth() + 1).padStart(2, '0');
        var day = String(newDate.getDate()).padStart(2, '0');
        var dateStr = year + '-' + month + '-' + day;
        window.location.href = planPageUrl + '?date=' + dateStr;
    }
    
    function selectDate(dateStr) {
        window.location.href = planPageUrl + '?date=' + dateStr;
    }
    
    if (prevWeekBtn) {
        prevWeekBtn.addEventListener('click', function() { navigateWeek('prev'); });
    }
    
    if (nextWeekBtn) {
        nextWeekBtn.addEventListener('click', function() { navigateWeek('next'); });
    }
    
    weekDayButtons.forEach(function(btn) {
        btn.addEventListener('click', function() {
            var dateStr = btn.getAttribute('data-date');
            if (dateStr) {
                selectDate(dateStr);
            }
        });
    });

    // ---------- classify ----------
    function classifyTaking(expectedDt, nowDt) {
        var diffMs = nowDt.getTime() - expectedDt.getTime();
        var diffHours = diffMs / (1000 * 60 * 60);
        var absDiff = Math.abs(diffHours);

        if (diffHours >= 24) {
            return { canComplete: false, status: "TOO_LATE", flag: null,
                     message: "Too late! can't complete" };
        }
        if (diffHours <= -24) {
            return { canComplete: false, status: "TOO_EARLY", flag: null,
                     message: "Too early! can't complete" };
        }
        if (absDiff < 1) {
            return { canComplete: true, status: "ON_TIME", flag: null, message: "" };
        }
        if (diffHours > 0) {
            return { canComplete: true, status: "LATE", flag: "LATE",
                     message: "A little bit late, your completion will be marked with late flag" };
        }
        return { canComplete: true, status: "EARLY", flag: "EARLY",
                 message: "A little bit early, your completion will be marked with early flag" };
    }

    function buildExpectedDate(li) {
        var dateStr = li.getAttribute('data-expected-date');
        var timeStr = li.getAttribute('data-expected-time');

        if (!dateStr) return null;

        if (timeStr && timeStr.length > 0) {
            return new Date(dateStr + "T" + timeStr);
        }
        return null;
    }

    function formatTimeHHMM(dt) {
        var h = String(dt.getHours()).padStart(2, '0');
        var m = String(dt.getMinutes()).padStart(2, '0');
        return h + ":" + m;
    }

    function formatLocalHHMM(isoString) {
        if (!isoString) return "";
        var dt = new Date(isoString);
        if (isNaN(dt.getTime())) return "";
        var h = String(dt.getHours()).padStart(2, '0');
        var m = String(dt.getMinutes()).padStart(2, '0');
        return h + ":" + m;
    }

    async function toggleDrugRecord(li, btn, result, nowDt) {
        if (!currentUserId) {
            showDialog("Missing user id", "Alert");
            return;
        }

        var planItemId = li.getAttribute('data-plan-item-id');
        var drugId = li.getAttribute('data-drug-id');
        var expectedDate = li.getAttribute('data-expected-date');
        var expectedTime = li.getAttribute('data-expected-time') || null;
        var isCompleted = li.getAttribute("data-completed") === "1";

        var payload = {
            user_id: Number(currentUserId),
            drug_id: Number(drugId),
            plan_item_id: Number(planItemId),
            expected_date: expectedDate,
            expected_time: expectedTime
        };

        if (!isCompleted) {
            payload.status = result.status;
            payload.timing_flag = result.flag;
            payload.taken_at = nowDt.toISOString();
        }

        try {
            const resp = await fetch("/mark_drug_taken", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });

            const data = await resp.json();

            if (!resp.ok || data.error) {
                showDialog(data.error || "Failed to toggle drug record", "Alert");
                return;
            }

            if (data.action === "deleted") {
                showDialog("Record deleted", "Success");
                
                li.classList.remove("plan-item--completed");
                li.setAttribute("data-completed", "0");
                li.setAttribute("data-completion-status", "");
                li.setAttribute("data-completion-time", "");

                if (btn) {
                    btn.classList.remove("checked");
                    btn.removeAttribute("disabled");
                    btn.setAttribute("aria-label", "Mark as completed");
                    btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>';
                }

                var statusSpan = li.querySelector(".plan-item-status");
                if (statusSpan) {
                    statusSpan.textContent = "";
                }
            } else if (data.action === "created") {
                if (result && result.message) {
                    showDialog(result.message, "Success");
                } else {
                    showDialog("Recorded as taken", "Success");
                }

                li.classList.add("plan-item--completed");
                li.setAttribute("data-completed", "1");
                if (result) {
                    li.setAttribute("data-completion-status", result.status || "");
                } else {
                    li.setAttribute("data-completion-status", "");
                }
                li.setAttribute("data-completion-time", nowDt.toISOString());

                // 更新checkbox为已勾选状态
                if (btn) {
                    btn.classList.add("checked");
                    btn.setAttribute("aria-label", "Already completed");
                    // 替换SVG为勾选图标
                    btn.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg>';
                }

                var statusSpan = li.querySelector(".plan-item-status");
                if (statusSpan && result) {
                    var timeStr = formatTimeHHMM(nowDt);
                    if (result.status === "ON_TIME") {
                        statusSpan.textContent = "Completed on time at " + timeStr;
                    } else if (result.status === "LATE") {
                        statusSpan.textContent = "Completed late at " + timeStr;
                    } else if (result.status === "EARLY") {
                        statusSpan.textContent = "Completed early at " + timeStr;
                    }
                }
            }

        } catch (e) {
            console.error(e);
            showDialog("Network error while toggling drug record", "Alert");
        }
    }

    // ---------- click handlers ----------
    var checkboxes = document.querySelectorAll('.plan-item-checkbox');
    checkboxes.forEach(function(btn) {
        btn.addEventListener('click', async function(e) {
            e.preventDefault();
            
            // 检查是否被禁用（过去日期）
            if (btn.disabled || btn.classList.contains('disabled')) {
                return;
            }
            
            var li = btn.closest('.plan-item');
            if (!li) return;

            var completed = li.getAttribute("data-completed");
            var isPastDate = li.getAttribute("data-is-past-date") === "1";

            // 如果是已完成的记录，直接toggle（删除）
            // 可以取消的记录：今天、昨天、以及未来的日期
            // 不能取消的记录：前天及更早的日期
            if (completed === "1") {
                // 检查是否是过去日期（前天及更早不能取消）
                if (isPastDate) {
                    showDialog("Cannot modify past dates.", "Alert");
                    return;
                }
                // 今天、昨天和未来的日期都可以取消记录
                // 直接删除记录，不需要验证时间
                await toggleDrugRecord(li, btn, null, new Date());
                return;
            }

            // 未完成的记录：检查是否可以完成
            // 检查是否是过去日期
            if (isPastDate) {
                showDialog("Cannot modify past dates.", "Alert");
                return;
            }

            var expectedDt = buildExpectedDate(li);
            if (!expectedDt) {
                showDialog("This item has no valid expected time; cannot complete.", "Alert");
                return;
            }

            var nowDt = new Date();
            var result = classifyTaking(expectedDt, nowDt);

            if (!result.canComplete) {
                showDialog(result.message, "Alert");
                return;
            }

            await toggleDrugRecord(li, btn, result, nowDt);
        });
    });

    // ---------- 初次加载时，把已完成项的时间改成本地 HH:MM ----------
    document.querySelectorAll('.plan-item').forEach(function(li) {
        var completed = li.getAttribute('data-completed') === '1';
        if (!completed) return;

        var status = li.getAttribute('data-completion-status');
        var takenIso = li.getAttribute('data-completion-time');
        if (!status || !takenIso) return;

        var hhmm = formatLocalHHMM(takenIso);
        if (!hhmm) return;

        var span = li.querySelector('.plan-item-status');
        if (!span) return;

        if (status === 'ON_TIME') {
            span.textContent = "Completed on time at " + hhmm;
        } else if (status === 'LATE') {
            span.textContent = "Completed late at " + hhmm;
        } else if (status === 'EARLY') {
            span.textContent = "Completed early at " + hhmm;
        }
    });

})();
</script>
{% endblock %}
{% extends 'patient_base.html' %}
{% block content %}
<div class="reminder-page">
    <!-- Current Reminder Card -->
    <div class="reminder-card reminder-card--current">
        {% if current_reminder %}
        <div class="reminder-card-row">
            <span class="reminder-label">Task Name:</span>
            <span class="reminder-value">{{ current_reminder.drug_name|default('Unknown') }}{% if current_reminder.dosage and current_reminder.unit %} {{ current_reminder.dosage }} {{ current_reminder.unit }}{% endif %}</span>
        </div>
        {% if current_reminder.note %}
        <div class="reminder-card-row">
            <span class="reminder-label">Notes:</span>
            <span class="reminder-value">{{ current_reminder.note }}</span>
        </div>
        {% endif %}
        <div class="reminder-card-row">
            <span class="reminder-label">Time:</span>
            <span class="reminder-value">{{ current_reminder.time|default('No time') }}</span>
        </div>
        {% else %}
        <!-- Placeholder data, will be replaced by backend data -->
        <div class="reminder-card-row">
            <span class="reminder-label">Task Name:</span>
            <span class="reminder-value">Ibuprofen 100mg</span>
        </div>
        <div class="reminder-card-row">
            <span class="reminder-label">Notes:</span>
            <span class="reminder-value">Take after breakfast</span>
        </div>
        <div class="reminder-card-row">
            <span class="reminder-label">Time:</span>
            <span class="reminder-value">8:00 AM</span>
        </div>
        {% endif %}
    </div>
    
    <!-- Status Display -->
    {% if current_reminder %}
    <div class="reminder-status">
        <span class="reminder-label">Status:</span>
        <span class="reminder-status-badge reminder-status-badge--pending">⏳ Pending</span>
    </div>
    {% endif %}
    
    <!-- Complete Button -->
    {% if current_reminder %}
    <button class="reminder-complete-btn" 
            aria-label="Mark as Completed"
            data-plan-item-id="{{ current_reminder.plan_item_id }}"
            data-drug-id="{{ current_reminder.drug_id }}"
            data-date-iso="{{ current_reminder.date_iso }}"
            data-time-iso="{{ current_reminder.time_iso|default('') }}"
            data-dosage="{{ current_reminder.dosage|default('') }}"
            data-unit="{{ current_reminder.unit|default('') }}"
            data-note="{{ current_reminder.note|default('') }}">Mark as Completed</button>
    {% else %}
    <button class="reminder-complete-btn" aria-label="Mark as Completed" disabled>Mark as Completed</button>
    {% endif %}
    
    <!-- Sync Note -->
    <div class="reminder-sync-note">Will sync when online</div>
    
    <!-- Upcoming Reminder -->
    <div class="reminder-card reminder-card--upcoming">
        <div class="reminder-card-header">Upcoming Reminder</div>
        {% if upcoming_reminder %}
        <div class="reminder-card-row">
            <span class="reminder-label">Task Name:</span>
            <span class="reminder-value">{{ upcoming_reminder.drug_name|default('Unknown') }}{% if upcoming_reminder.dosage and upcoming_reminder.unit %} {{ upcoming_reminder.dosage }} {{ upcoming_reminder.unit }}{% endif %}</span>
        </div>
        {% if upcoming_reminder.note %}
        <div class="reminder-card-row">
            <span class="reminder-label">Notes:</span>
            <span class="reminder-value">{{ upcoming_reminder.note }}</span>
        </div>
        {% endif %}
        <div class="reminder-card-row">
            <span class="reminder-label">Time:</span>
            <span class="reminder-value">{{ upcoming_reminder.time|default('No time') }}</span>
        </div>
        {% else %}
        <!-- Placeholder data, will be replaced by backend data -->
        <div class="reminder-card-row">
            <span class="reminder-label">Task Name:</span>
            <span class="reminder-value">Ibuprofen 100mg</span>
        </div>
        <div class="reminder-card-row">
            <span class="reminder-label">Notes:</span>
            <span class="reminder-value">Take after dinner</span>
        </div>
        <div class="reminder-card-row">
            <span class="reminder-label">Time:</span>
            <span class="reminder-value">8:00 PM</span>
        </div>
        {% endif %}
    </div>
    
    <!-- Success Banner -->
    <div class="reminder-success-banner" id="success-banner" role="alert" style="display: none;">
        ⚡ Status updated successfully
    </div>
</div>

<script>
(function() {
    const completeBtn = document.querySelector('.reminder-complete-btn');
    const successBanner = document.getElementById('success-banner');
    const statusBadge = document.querySelector('.reminder-status-badge');
    
    const userId = {% if user_id %}{{ user_id }}{% else %}null{% endif %};
    if (!userId) {
        console.error('User ID not available');
        return;
    }
    
    if (!completeBtn || completeBtn.disabled) {
        return;
    }
    
    // Get reminder info from button data attributes
    const reminderData = {
        planItemId: parseInt(completeBtn.dataset.planItemId),
        drugId: parseInt(completeBtn.dataset.drugId),
        dateIso: completeBtn.dataset.dateIso,
        timeIso: completeBtn.dataset.timeIso || null,
        dosage: completeBtn.dataset.dosage || null,
        unit: completeBtn.dataset.unit || '',
        note: completeBtn.dataset.note || ''
    };
    
    // Update UI to show completed status
    function updateUIForCompleted() {
        if (statusBadge) {
            statusBadge.textContent = '✅ Completed';
            statusBadge.className = 'reminder-status-badge reminder-status-badge--completed';
        }
        if (completeBtn && !completeBtn.disabled) {
            completeBtn.textContent = 'Completed ✓';
            completeBtn.style.opacity = '0.6';
            completeBtn.disabled = true;
        }
    }
    
    // Check if current reminder is completed on page load
    async function checkReminderStatus() {
        try {
            const recordsResponse = await fetch(`/get_drug_records_by_user_id?user_id=${userId}`);
            if (!recordsResponse.ok) {
                console.error('Failed to fetch drug records on page load');
                return;
            }
            const allRecords = await recordsResponse.json();
            
            // Find existing record by plan_item_id and date
            const existingRecord = allRecords.find(record => 
                record.plan_item_id === reminderData.planItemId &&
                record.taken_date === reminderData.dateIso &&
                (record.status === 'TAKEN' || record.status === 'ON_TIME')
            );
            
            if (existingRecord) {
                // Update UI if record exists with TAKEN or ON_TIME status
                updateUIForCompleted();
            }
        } catch (error) {
            console.error('Error checking reminder status:', error);
        }
    }
    
    // Check on page load
    checkReminderStatus();
    
    completeBtn.addEventListener('click', async function() {
        // Disable button to prevent duplicate clicks
        completeBtn.disabled = true;
        completeBtn.textContent = 'Processing...';
        
        try {
            // Get all drug records for user
            const recordsResponse = await fetch(`/get_drug_records_by_user_id?user_id=${userId}`);
            if (!recordsResponse.ok) {
                throw new Error('Failed to fetch drug records');
            }
            const allRecords = await recordsResponse.json();
            
            // Find existing record by plan_item_id and date
            const existingRecord = allRecords.find(record => 
                record.plan_item_id === reminderData.planItemId &&
                record.taken_date === reminderData.dateIso
            );
            
            if (existingRecord) {
                // Update record status to TAKEN
                const params = new URLSearchParams({
                    id: existingRecord.id.toString(),
                    status: 'TAKEN'
                });
                if (reminderData.dosage) {
                    params.append('dosage_numeric', reminderData.dosage);
                }
                if (reminderData.unit) {
                    params.append('unit', reminderData.unit);
                }
                if (reminderData.note) {
                    params.append('notes', reminderData.note);
                }
                const updateUrl = `/update_drug_record?${params.toString()}`;
                const updateResponse = await fetch(updateUrl);
                
                if (!updateResponse.ok) {
                    throw new Error('Failed to update drug record');
                }
                
                console.log('Drug record updated:', await updateResponse.json());
            } else {
                // Create new record if it doesn't exist
                const createData = {
                    user_id: userId,
                    drug_id: reminderData.drugId,
                    taken_date: reminderData.dateIso,
                    taken_time: reminderData.timeIso,
                    dosage_numeric: reminderData.dosage ? parseFloat(reminderData.dosage) : null,
                    unit: reminderData.unit,
                    plan_item_id: reminderData.planItemId,
                    status: 'TAKEN',
                    notes: reminderData.note
                };
                
                const createResponse = await fetch('/create_drug_record', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(createData)
                });
                
                if (!createResponse.ok) {
                    throw new Error('Failed to create drug record');
                }
                
                console.log('Drug record created:', await createResponse.json());
            }
            
            // Update UI: show success message and update status badge
            successBanner.style.display = 'block';
            updateUIForCompleted();
            
            // Hide success message after 3 seconds
            setTimeout(() => {
                successBanner.style.display = 'none';
            }, 3000);
            
        } catch (error) {
            console.error('Error marking reminder as complete:', error);
            alert('Failed to mark as completed. Please try again.');
            completeBtn.disabled = false;
            completeBtn.textContent = 'Mark as Completed';
        }
    });
})();
</script>
{% endblock %}
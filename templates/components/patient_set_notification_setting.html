<div class="card my-3" id="patient-notification-setting-{{ uid }}" data-user-id="{{ uid }}">
  <div class="card-body">
    <h5 class="card-title">Notification Settings</h5>
    <p class="text-muted mb-3">
      Configure when you want to receive task notifications.
      Time unit: minutes.
      <br />
      Positive = before task start; 0 = at start time; negative = after overdue.
    </p>

    <form class="patient-notification-form">
      <!-- Enable / Disable notifications -->
      <div class="form-check form-switch mb-2">
        <input
          class="form-check-input"
          type="checkbox"
          id="notif-enabled-{{ uid }}"
          name="enabled"
        />
        <label class="form-check-label" for="notif-enabled-{{ uid }}">
          Enable notifications
        </label>
      </div>

      <!-- Email notifications -->
      <div class="form-check form-switch mb-3">
        <input
          class="form-check-input"
          type="checkbox"
          id="notif-email-enabled-{{ uid }}"
          name="email_enabled"
        />
        <label class="form-check-label" for="notif-email-enabled-{{ uid }}">
          Send notifications via email
        </label>
      </div>

      <!-- Notify minutes -->
      <div class="mb-3">
        <label class="form-label" for="notif-minutes-input-{{ uid }}">
          Notification times (comma-separated, e.g. <code>60,0,-60</code>)
        </label>
        <input
          type="text"
          class="form-control"
          id="notif-minutes-input-{{ uid }}"
          name="notify_minutes"
          placeholder="Example: 60,0,-60"
        />
        <div class="form-text" id="notif-minutes-preview-{{ uid }}">
          Example: 60 = 60 minutes before; -60 = 60 minutes after overdue.
        </div>
      </div>

      <!-- Timezone -->
      <div class="mb-3">
        <label class="form-label" for="notif-timezone-{{ uid }}">
          Timezone (e.g. UTC-5)
        </label>
        <input
          type="text"
          class="form-control"
          id="notif-timezone-{{ uid }}"
          name="timezone"
          value="UTC-5"
        />
      </div>

      <div class="d-flex align-items-center" style="gap: 8px;">
        <button type="submit" class="btn btn-primary btn-sm">
          Save Settings
        </button>
        <span class="small text-muted patient-notif-status"></span>
      </div>
    </form>
  </div>
</div>

<script>
  (function () {
    const root = document.getElementById(
      "patient-notification-setting-{{ uid }}"
    );
    if (!root) return;

    const userId = parseInt(root.dataset.userId, 10);
    const form = root.querySelector(".patient-notification-form");
    const enabledInput = root.querySelector("#notif-enabled-{{ uid }}");
    const emailEnabledInput = root.querySelector(
      "#notif-email-enabled-{{ uid }}"
    );
    const minutesInput = root.querySelector(
      "#notif-minutes-input-{{ uid }}"
    );
    const minutesPreview = root.querySelector(
      "#notif-minutes-preview-{{ uid }}"
    );
    const timezoneInput = root.querySelector("#notif-timezone-{{ uid }}");
    const statusSpan = root.querySelector(".patient-notif-status");

    // Default config if no record exists
    const DEFAULT_CONFIG = {
      enabled: true,
      email_enabled: true,
      notify_minutes: [60, 0, -60],
      timezone: "UTC-5",
    };

    function parseMinutes(str) {
      return (str || "")
        .split(",")
        .map((s) => s.trim())
        .filter((s) => s !== "")
        .map((s) => {
          const n = parseInt(s, 10);
          return isNaN(n) ? null : n;
        })
        .filter((n) => n !== null);
    }

    function describeOffset(n) {
      if (n > 0) return `${n} minutes before task start`;
      if (n === 0) return `at task start time`;
      return `${Math.abs(n)} minutes after overdue`;
    }

    function renderPreview() {
      const arr = parseMinutes(minutesInput.value);
      if (!arr.length) {
        minutesPreview.textContent =
          "Positive = before start; 0 = start; negative = after overdue.";
        return;
      }
      minutesPreview.textContent = arr.map(describeOffset).join("; ");
    }

    async function loadConfig() {
      try {
        const resp = await fetch(`/get_notification_setting?id=${userId}`);
        let cfg = resp.ok ? await resp.json() : DEFAULT_CONFIG;

        enabledInput.checked = cfg.enabled ?? DEFAULT_CONFIG.enabled;
        emailEnabledInput.checked =
          cfg.email_enabled ?? DEFAULT_CONFIG.email_enabled;

        const mins = Array.isArray(cfg.notify_minutes)
          ? cfg.notify_minutes
          : DEFAULT_CONFIG.notify_minutes;
        minutesInput.value = mins.join(",");

        timezoneInput.value = cfg.timezone || DEFAULT_CONFIG.timezone;

        renderPreview();
      } catch (err) {
        console.error(err);
        enabledInput.checked = DEFAULT_CONFIG.enabled;
        emailEnabledInput.checked = DEFAULT_CONFIG.email_enabled;
        minutesInput.value = DEFAULT_CONFIG.notify_minutes.join(",");
        timezoneInput.value = DEFAULT_CONFIG.timezone;
        renderPreview();
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      statusSpan.textContent = "Savingâ€¦";

      const minutes = parseMinutes(minutesInput.value);

      const payload = {
        user_id: userId,
        enabled: enabledInput.checked,
        email_enabled: emailEnabledInput.checked,
        notify_minutes: minutes,
        timezone: timezoneInput.value || "UTC-5",
      };

      try {
        const resp = await fetch("/update_notification_setting", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!resp.ok) throw new Error("Save failed");

        statusSpan.textContent = "Saved";
        statusSpan.classList.add("text-success");
      } catch (err) {
        console.error(err);
        statusSpan.textContent = "Failed to save";
        statusSpan.classList.add("text-danger");
      }
    });

    minutesInput.addEventListener("input", renderPreview);

    loadConfig();
  })();
</script>
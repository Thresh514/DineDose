<script>
/**
 * Generic calendar component (Doctor View version)
 * Fetches drug records from /get_drug_records_by_user_id?user_id=xx,
 * calculates EARLY / ON_TIME / LATE using expected_date/time + updated_at.
 */
function create_calendar(options) {
    const {
        userId,
        planApiBase    = "/get_user_plan",
        drugApiBase    = "/get_drug",
        recordsApiBase = "/get_drug_records_by_user_id",

        calendarId      = "calendar",
        prevBtnId       = "prev-btn",
        nextBtnId       = "next-btn",
        viewBtnSelector = ".view-btn",
        rangeLabelId    = "current-range",
        loadingOverlayId= "loading-overlay",
        modalId         = "event-modal",
        modalCloseId    = "modal-close",
        modalBodyId     = "modal-body",
    } = options;

    // ==== DOM ====
    const calendarEl       = document.getElementById(calendarId);
    const prevBtn          = document.getElementById(prevBtnId);
    const nextBtn          = document.getElementById(nextBtnId);
    const rangeLabelEl     = document.getElementById(rangeLabelId);
    const loadingOverlayEl = document.getElementById(loadingOverlayId);
    const modalEl          = document.getElementById(modalId);
    const modalCloseBtn    = document.getElementById(modalCloseId);
    const modalBodyEl      = document.getElementById(modalBodyId);
    const viewButtons      = document.querySelectorAll(viewBtnSelector);

    if (!calendarEl) {
        console.error("Calendar element not found:", calendarId);
        return;
    }

    // ==== loading ====
    function showLoading() {
        if (loadingOverlayEl) loadingOverlayEl.style.display = "flex";
    }
    function hideLoading() {
        if (loadingOverlayEl) loadingOverlayEl.style.display = "none";
    }

    // ==== state ====
    let currentView   = "month";       // "day" | "week" | "month"
    let currentAnchor = new Date();    // ÂΩìÂâçËßÜÂõæ‰∏≠ÂøÉÊó•Êúü

    const planCache = {};              // key -> plan_item
    let   allPlanItems = [];

    let loadedFrom = null;             // Â∑≤Âä†ËΩΩËÆ°ÂàíÁöÑÂºÄÂßãÊó•Êúü
    let loadedTo   = null;             // Â∑≤Âä†ËΩΩËÆ°ÂàíÁöÑÁªìÊùüÊó•Êúü

    const drugCache   = {};            // drug_id -> drug detail
    const recordMap   = {};            // key(plan_item+date+time) -> {status, takenAt: Date}
    let   recordsLoaded = false;       // ÊúçËçØËÆ∞ÂΩïÂè™Êãâ‰∏ÄÊ¨°

    // ==== Utility Functions ====
    function toISODate(d) {
        return d.toISOString().slice(0, 10);
    }
    function truncDate(d) {
        return new Date(d.getFullYear(), d.getMonth(), d.getDate());
    }
    function getWeekStart(d) {
        const tmp = truncDate(d);
        const day = tmp.getDay();
        const diff = (day + 6) % 7; // Monday = 0
        tmp.setDate(tmp.getDate() - diff);
        return tmp;
    }
    function addDays(date, delta) {
        const d = new Date(date);
        d.setDate(d.getDate() + delta);
        return d;
    }
    function updateRangeLabel(from, to) {
        if (!rangeLabelEl) return;
        rangeLabelEl.textContent = `${toISODate(from)} ‚Üí ${toISODate(to)}`;
    }
    function makeKeyFromItem(item) {
        return `${item.id}_${item.date}_${item.time || ""}`;
    }
    function makeKeyFromRecord(rec) {
        return `${rec.plan_item_id}_${rec.expected_date}_${rec.expected_time || ""}`;
    }
    function fmtHHMM(dt) {
        const h = String(dt.getHours()).padStart(2, "0");
        const m = String(dt.getMinutes()).padStart(2, "0");
        return `${h}:${m}`;
    }

    function mergePlanItems(items) {
        if (!items) return;
        for (const it of items) {
            planCache[makeKeyFromItem(it)] = it;
        }
        allPlanItems = Object.values(planCache);
    }

    function computeViewRange(anchor, view) {
        const base = truncDate(anchor);
        let from, to;

        if (view === "day") {
            from = base;
            to   = base;
        } else if (view === "week") {
            from = getWeekStart(base);
            to   = addDays(from, 6);
        } else {
            // month
            from = new Date(base.getFullYear(), base.getMonth(), 1);
            to   = new Date(base.getFullYear(), base.getMonth() + 1, 0);
        }
        return { from, to };
    }

    // ==== Fetch Plans ====
    async function fetchRange(fromDate, toDate) {
        const fromStr = toISODate(fromDate);
        const toStr   = toISODate(toDate);

        const url = `${planApiBase}?id=${userId}&from=${fromStr}&to=${toStr}`;
        const res = await fetch(url);
        if (!res.ok) {
            console.error("fetchRange failed:", res.status);
            return;
        }
        const data = await res.json();
        mergePlanItems(data.plan_items || []);
    }

    async function ensureDataForRange(fromDate, toDate) {
        fromDate = truncDate(fromDate);
        toDate   = truncDate(toDate);

        if (!loadedFrom || !loadedTo) {
            await fetchRange(fromDate, toDate);
            loadedFrom = new Date(fromDate);
            loadedTo   = new Date(toDate);
            return;
        }

        const tasks = [];
        if (fromDate < loadedFrom) {
            const newFrom = new Date(fromDate);
            const newTo   = addDays(loadedFrom, -1);
            tasks.push(fetchRange(newFrom, newTo).then(() => { loadedFrom = newFrom; }));
        }
        if (toDate > loadedTo) {
            const newFrom = addDays(loadedTo, 1);
            const newTo   = new Date(toDate);
            tasks.push(fetchRange(newFrom, newTo).then(() => { loadedTo = newTo; }));
        }
        if (tasks.length) await Promise.all(tasks);
    }

    // ==== Fetch Drug Records (one-time) ====
    async function fetchDrugRecordsOnce() {
        if (recordsLoaded) return;
        const url = `${recordsApiBase}?user_id=${userId}`;
        try {
            const res = await fetch(url);
            if (!res.ok) {
                console.error("fetchDrugRecords failed:", res.status);
                recordsLoaded = true;
                return;
            }
            const list = await res.json();  // Array
            buildRecordMap(list || []);
            recordsLoaded = true;
        } catch (e) {
            console.error("fetchDrugRecords error:", e);
            recordsLoaded = true;
        }
    }

    // Calculate EARLY / ON_TIME / LATE using updated_at + expected_date/time
    function buildRecordMap(records) {
        records.forEach(rec => {
            if (!rec.plan_item_id || !rec.expected_date) return;

            const key = makeKeyFromRecord(rec);
            if (!rec.updated_at) {
                // Skip if no updated_at
                return;
            }

            try {
                const updated = new Date(rec.updated_at); // Has timezone
                // expected_time may be "12:00:00" or null
                const timeStr = rec.expected_time || "00:00:00";
                const expectedLocal = new Date(rec.expected_date + "T" + timeStr);

                const diffMs    = updated.getTime() - expectedLocal.getTime();
                const diffHours = diffMs / (1000 * 60 * 60);
                const absDiff   = Math.abs(diffHours);

                let status = "ON_TIME";
                if (absDiff < 1) {
                    status = "ON_TIME";
                } else if (diffHours > 0) {
                    status = "LATE";
                } else {
                    status = "EARLY";
                }

                recordMap[key] = {
                    status: status,
                    takenAt: updated
                };
            } catch (e) {
                console.error("buildRecordMap error:", e, rec);
            }
        });
    }

    // ==== Modal ====
    function openModal(htmlContent) {
        if (!modalEl || !modalBodyEl) return;
        modalBodyEl.innerHTML = htmlContent;
        modalEl.style.display = "flex";
    }
    function closeModal() {
        if (!modalEl) return;
        modalEl.style.display = "none";
    }
    if (modalCloseBtn) modalCloseBtn.onclick = closeModal;
    if (modalEl) {
        modalEl.onclick = function (e) {
            if (e.target.id === modalId) closeModal();
        };
    }

    // Drug details (with cache)
    async function fetchDrugDetail(drugId) {
        if (!drugId) return null;
        if (drugCache[drugId]) return drugCache[drugId];

        try {
            const res = await fetch(`${drugApiBase}?id=${drugId}`);
            if (!res.ok) return null;
            const data = await res.json();
            drugCache[drugId] = data;
            return data;
        } catch (e) {
            console.error("fetchDrugDetail error:", e);
            return null;
        }
    }

    async function showEventDetail(ev) {
        const drug = await fetchDrugDetail(ev.drug_id);

        // Get status from recordMap
        const key = makeKeyFromItem(ev);
        const rec = recordMap[key];

        let statusLine = "<p><strong>Status:</strong> Not taken yet</p>";
        if (rec) {
            const tStr = fmtHHMM(rec.takenAt);
            if (rec.status === "ON_TIME") {
                statusLine = `<p><strong>Status:</strong> Taken on time at ${tStr}</p>`;
            } else if (rec.status === "EARLY") {
                statusLine = `<p><strong>Status:</strong> Taken early at ${tStr}</p>`;
            } else if (rec.status === "LATE") {
                statusLine = `<p><strong>Status:</strong> Taken late at ${tStr}</p>`;
            }
        }

        let drugHTML = "";
        if (drug) {
            drugHTML = `
                <h4>${drug.brand_name}</h4>
                <p><strong>Generic:</strong> ${drug.generic_name}</p>
                <p><strong>Route:</strong> ${drug.route}</p>
                <p><strong>Dosage form:</strong> ${drug.dosage_form}</p>
                <p><strong>Product NDC:</strong> ${drug.product_ndc}</p>
                <p><strong>Labeler:</strong> ${drug.labeler_name}</p>
                <p><strong>Marketing category:</strong> ${drug.marketing_category}</p>
            `;
        } else {
            drugHTML = `<p>‚ö† Unable to load drug details.</p>`;
        }

        const eventHTML = `
            <div style="border-bottom:1px solid #ddd; padding-bottom:8px; margin-bottom:10px;">
                <p><strong>Date:</strong> ${ev.date}</p>
                <p><strong>Time:</strong> ${ev.time || "ALL DAY"}</p>
            </div>

            ${statusLine}

            <p><strong>Medication:</strong> ${ev.drug_name}</p>
            <p><strong>Dosage:</strong> ${ev.dosage}${ev.unit}</p>
            <p><strong>Amount literal:</strong> ${ev.amount_literal || "(none)"}</p>
            <p><strong>Note:</strong> ${ev.note || "(none)"}</p>

            <hr>

            <h3 style="margin-top:10px;">Drug Information</h3>
            ${drugHTML}
        `;
        openModal(eventHTML);
    }

    // ==== Rendering ====
    async function loadAndRenderCurrentView() {
        showLoading();
        try {
            const { from, to } = computeViewRange(currentAnchor, currentView);
            // Load drug records into recordMap first
            await fetchDrugRecordsOnce();
            // Then ensure plan data
            await ensureDataForRange(from, to);
            renderFromCache(from, to);
        } finally {
            hideLoading();
        }
    }

    function renderFromCache(fromDate, toDate) {
        const fromStr = toISODate(fromDate);
        const toStr   = toISODate(toDate);

        const visible = allPlanItems.filter(it =>
            it.date >= fromStr && it.date <= toStr
        );

        renderCalendar(visible, fromDate, toDate);
        updateRangeLabel(fromDate, toDate);
    }

    function renderCalendar(planItems, fromDate, toDate) {
        calendarEl.innerHTML = "";
        calendarEl.classList.remove("day-view", "week-view", "month-view");
        calendarEl.classList.add(currentView + "-view");

        if (!planItems.length) {
            calendarEl.className = "calendar day-view";
            const cell = document.createElement("div");
            cell.className = "day";
            cell.innerHTML = `
                <div class="day-header">${toISODate(fromDate)} ‚Üí ${toISODate(toDate)}</div>
                <div style="margin-top:8px; text-align:center; font-size:13px;">
                   üòä No schedules in this period.
                </div>`;
            calendarEl.appendChild(cell);
            return;
        }

        // date -> events
        const map = {};
        for (const item of planItems) {
            (map[item.date] ||= []).push(item);
        }

        const cur = new Date(fromDate);
        while (cur <= toDate) {
            const dateStr = toISODate(cur);
            const cell = document.createElement("div");
            cell.className = "day";
            cell.innerHTML = `<div class="day-header">${dateStr}</div>`;

            const events = map[dateStr];
            if (events) {
                events.sort((a, b) => (a.time || "").localeCompare(b.time || ""));
                for (const ev of events) {
                    const key = makeKeyFromItem(ev);
                    const rec = recordMap[key];

                    let statusText = "Not taken yet";
                    let statusClass = "event-status--not";

                    if (rec) {
                        const tStr = fmtHHMM(rec.takenAt);
                        if (rec.status === "ON_TIME") {
                            statusText  = `Taken on time at ${tStr}`;
                            statusClass = "event-status--on";
                        } else if (rec.status === "EARLY") {
                            statusText  = `Taken early at ${tStr}`;
                            statusClass = "event-status--early";
                        } else if (rec.status === "LATE") {
                            statusText  = `Taken late at ${tStr}`;
                            statusClass = "event-status--late";
                        }
                    }

                    const el = document.createElement("div");
                    el.className = "event";
                    el.innerHTML = `
                        <div><strong>${ev.time || "ALL DAY"}</strong></div>
                        <div>${ev.drug_name}</div>
                        <div>${ev.dosage}${ev.unit} (${ev.amount_literal || ""})</div>
                        <div class="event-status ${statusClass}">${statusText}</div>
                    `;
                    el.style.cursor = "pointer";
                    el.onclick = () => showEventDetail(ev);
                    cell.appendChild(el);
                }
            }

            calendarEl.appendChild(cell);
            cur.setDate(cur.getDate() + 1);
        }
    }

    // ==== Controls ====
    function initViewButtons() {
        viewButtons.forEach(btn => {
            btn.addEventListener("click", () => {
                currentView = btn.dataset.view;
                viewButtons.forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                loadAndRenderCurrentView();
            });
        });

        const monthBtn = document.querySelector(`${viewBtnSelector}[data-view="month"]`);
        if (monthBtn) monthBtn.classList.add("active");
    }

    function initNavButtons() {
        if (prevBtn) {
            prevBtn.addEventListener("click", () => shiftAnchor(-1));
        }
        if (nextBtn) {
            nextBtn.addEventListener("click", () => shiftAnchor(1));
        }
    }

    function shiftAnchor(direction) {
        if (currentView === "day") {
            currentAnchor.setDate(currentAnchor.getDate() + direction);
        } else if (currentView === "week") {
            currentAnchor.setDate(currentAnchor.getDate() + 7 * direction);
        } else {
            currentAnchor.setMonth(currentAnchor.getMonth() + direction);
        }
        loadAndRenderCurrentView();
    }

    // ==== Initialization ====
    initViewButtons();
    initNavButtons();
    loadAndRenderCurrentView();

    // Return optional API
    return {
        refresh: loadAndRenderCurrentView,
        setView(view) {
            currentView = view;
            loadAndRenderCurrentView();
        },
        setAnchor(date) {
            currentAnchor = new Date(date);
            loadAndRenderCurrentView();
        }
    };
}
</script>